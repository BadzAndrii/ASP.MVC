@using Lab2Server.Models

@{
    ViewBag.Title = "Books";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h2>@ViewBag.Title <sup>admin</sup></h2>

<p>
    <a href="javascript:void(0)" class="open-book-dialog" data-id="0">
        <i class="fa fa-plus-square"></i> Create
    </a>
</p>

@Html.Partial("_ListOfBooks")

@{
    var model = new EditBookModel();
    <div id="edit-book-modal" title="Edit book">
        <form id="book-dialog-form">
            <div class="form-horizontal">
                <input type="hidden" id="Id" name="Id" value="" />
                <div>
                    <div class="form-group">
                        <input type="text" value="" id="Name" name="Name" class="form-control required" placeholder="Name" required />
                    </div>
                    <div class="form-group">
                        <textarea id="Description" name="Description" class="form-control" placeholder="Description"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="text" value="" id="Year" name="Year" min="1900" max="@DateTime.UtcNow.Year" class="form-control required" placeholder="Year" required />
                    </div>
                    @Html.Partial("EditorTemplates/_MultiSelect", new MultiSelectList(new dynamic[] { }))
                    @Html.Partial("EditorTemplates/_PhotoUpload", model.PhotoUpload)
                </div>
                <div class="preview-photo">
                    <img alt="" class="form-control" src="" />
                </div>
            </div>
        </form>


        <script>
            $(function () {
                var $editBook = $("#edit-book-modal"),
                    populateData = (id) => {
                        id = Number(id);

                        $editBook.first("input#Id").val(id);

                        return $.get("/api/books/" + id)
                            .then((bookData) => {
                                console.log(bookData);
                                $editBook.find("input#Name").val(bookData.Name);
                                $editBook.find("textarea#Description").val(bookData.Description);
                                $editBook.find("input#Year").val(bookData.Year);
                                $editBook.find("img.form-control").prop({ src: bookData.Photo || "/Content/no-book-preview.png" });

                                var select = $editBook.find("select.form-control");

                                select.html(
                                    bookData.Authors
                                        .map((a) => {
                                            return a.Selected
                                                ? "<option value='" + a.Value + "' selected>" + a.Text + "</option>"
                                                : "<option value='" + a.Value + "' >" + a.Text + "</option>"
                                        })
                                        .reduce((acc, curr) => acc + curr));
                            });
                    },
                    openDialog = (e) => {
                        var id = $(e.currentTarget).data("id");

                        populateData(id)
                            .then(() => { $editBook.dialog({ title: id ? "Edit" : "Create" }).dialog("open"); });
                    },
                    deleteDialog = (e) => {
                        var id = $(e.currentTarget).data("id");
                        $.ajax({
                            url: "/api/books/" + id,
                            type: "DELETE"
                        }).then(reLoadBooks);
                    },
                    createRequestBody = () => {
                        var requestBody = new FormData();
                        
                        requestBody.append("Id", $editBook.find("#Id").val());
                        requestBody.append("Name", $editBook.find("#Name").val());
                        requestBody.append("Description", $editBook.find("#Description").val());
                        requestBody.append("Year", $editBook.find("#Year").val());
                        requestBody.append("SelectedAuthorsIds", $editBook.find("#SelectedAuthorsIds").val());
                        requestBody.append("PhotoUpload", $editBook.find("#PhotoUpload")[0].files[0]);

                        return requestBody;
                    };
                
                $(document).on("click", ".open-book-dialog", openDialog);
                $(document).on("click", ".delete-book-dialog", deleteDialog);

                $editBook
                    .dialog({
                        modal: true,
                        autoOpen: false,
                        width: 600,
                        height: 450,
                        buttons: {
                            "Save": () => {
                                var id = Number($editBook.first("input#Id").val()),
                                    requestBody = createRequestBody();

                                $.ajax({
                                    url: url = id ? "/api/books/" + id : "/api/books/",
                                    type: id ? "PUT" : "POST",
                                    data: requestBody,
                                    processData: false,
                                    contentType: false,
                                })
                                .then(reLoadBooks);

                                $editBook.dialog("close");
                            },
                            Cancel: () => { $editBook.dialog("close"); }
                        },
                        close: () => { $editBook.find(".required").removeClass("ui-state-error").val(""); }
                    });
            });
        </script>
    </div>
}
